---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Pre procesamiento

  - Recopilación
  - Importación
  - Exploración
    * Diccionario de variables
    * Niveles de agregación
    * Descripción univariada 
    * Identificando relaciones
    * Aproximación Visual (Visualización)
  - Filtrado y selección
    * Filtrado de observaciones
    * Selección de variables
    * Pivot, Reshape
    * Uniendo bases de datos
  - Muestreo, estimación, error estándar y confiabilidad
    * Diseño muestral
    * Estimación
    * Rendimiento
  - Transformación
    * Adecuación de formatos
    * Limpieza de texto
    * Creación de variables
    * Valores atípicos
    * Valores perdidos

## Importación

```{r}
#bookdown::clean_book(TRUE)
#bookdown::render_book("index.Rmd", "bookdown::gitbook")
rm(list=ls())
load(url("https://github.com/AlvaroLimber/EST-383/raw/master/data/oct20.RData"))
```

## Exploración

  + Filas/observaciones: Mesas electorales
  + Hay información a nivel de mesas según el tipo de elección.
  + La cobertura espacial: No solo es Bolivia

### Diccionario de variables

```{r}
dim(computo)
nrow(computo)
ncol(computo)
names(computo)
str(computo)
str(computo$País)
typeof(computo$País)
```

### Agregación/Niveles

```{r}
aux<-unique(computo$Elección)
length(unique(computo$`Código Mesa`))
library(dplyr)
#filtrado ctr+alt*M
bdpv<-computo %>% filter(Elección==aux[1])
bddu<-computo %>% filter(Elección==aux[2])
bdde<-computo %>% filter(Elección==aux[3])
save(bdpv,bddu,bdde,file="bd_elecciones20.RData")
```

### Descripción univariada

  + Tablas de frecuencia (cualitativas)
  + Reportes estadísticos; media, sd, etc. (Cuantitativas)
  + Gráficos (mix)

```{r}
# Ejercicio: Crear un vector que haga la diferencia entre variables cualitativas y cuantitativas.
dcuanti<-function(bd){
  bd<-data.frame(bd)
  aux<-NULL
  for(i in 1:ncol(bd)){
    aux[i]<-is.numeric(bd[,i])
  }
  return(aux)
}
dcuanti(bdpv)

#typeof(bdpv)
#str(bdpv)

#bdpv<-data.frame(bdpv)
#is.numeric(bdpv[,"MNR"])
#is.numeric(bdpv[,21])
#is.numeric(bdpv$MNR)
vcuanti<-names(bdpv)[dcuanti(bdpv)]
vcuali<-names(bdpv)[!dcuanti(bdpv)]
library(Hmisc)
describe(bdpv[,vcuanti])
describe(bdpv[,vcuali])
#Tarea: Escribir una función que permita explorar las características de las variables, según su naturaleza
#cualitativa
t1<-table(bdpv$Departamento)
aux1<-as.data.frame(prop.table(t1)*100)#%
aux2<-as.data.frame(t1)#frecuencias
names(aux1)[2]<-"Porcentaje"
tt1<-merge(aux1,aux2)#unir base de datos
head(tt1)
library(dplyr)#Gramática de datos

bdpv %>% group_by(Departamento) %>% count() 

tt1<-bdpv %>% group_by(Departamento) %>% summarise(Freq=n()) %>% mutate(Porcentaje=(Freq/sum(Freq))*100)
library(ggplot2)# gramàtica de gràficos
ggplot(bdpv,aes(Departamento))+geom_bar()

tt1

ggplot(tt1[1:10,],aes(Departamento,Porcentaje))+geom_bar(stat="identity")

ggplot(tt1 %>% filter(Porcentaje>1),aes(Departamento,Porcentaje))+geom_bar(stat="identity")

#cuantitativas
mean(bdpv$Blancos)
median(bdpv$Blancos)
summary(bdpv$Blancos)
sd(bdpv$Blancos)
sd(bdpv$Blancos)/mean(bdpv$Blancos)
quantile(bdpv$Blancos,seq(0,1,0.1))
quantile(bdpv$Blancos,seq(0,1,0.05))
hist(bdpv$Blancos)
plot(density(bdpv$Blancos))
boxplot(bdpv$Blancos)

boxplot(log(bdpv$Blancos))
plot(density(log(bdpv$Blancos)))
```

## Relaciones entre 2 variables 
  * Cuali vs cuali
  * Cuanti vs cuanti
  * Cuali vs cuanti
  
```{r}
rm(list=ls())
load(url("https://github.com/AlvaroLimber/EST-384/raw/master/data/eh19.RData"))
#cuali vs cuali
#eh19p$s02a_02#sexo
#eh19p$p0#pobreza monetaria moderada

t2<-table(eh19p$s02a_02,eh19p$p0)
t2
prop.table(t2)
prop.table(t2,1)
prop.table(t2,2)
chisq.test(t2)# H0: Independencia
plot(eh19p$s02a_02,eh19p$p0)
plot(eh19p$area,eh19p$p0)
plot(eh19p$niv_ed,eh19p$p0)

chisq.test(table(eh19p$niv_ed,eh19p$p0))
```

### Cuanti vs Cuanti

```{r}
#eh19p$s02a_03#edad
#eh19p$aestudio# años de educación
#eh19p$ylab# ingreso laboral

cor(eh19p[,c("s02a_03","aestudio","ylab")],use="complete.obs")
cor(eh19p[,c("s02a_03","aestudio","ylab")],use="pairwise.complete.obs")

nrow(na.omit(eh19p[,c("s02a_03","aestudio","ylab")]))
nrow(na.omit(eh19p[,c("s02a_03","aestudio")]))

library(GGally)

ggpairs(eh19p,columns = c("s02a_03","aestudio","ylab"))

ggpairs(eh19p,columns = c("s02a_02","aestudio","ylab","p0"))
```

## Filtrado y selección

Es el proceso que reduce la base de datos a la **población objetivo** y especifíca las **variables** a utilizar en el **modelado** posterior. Además de incorporar otras variables provenientes de otras bases de datos si es necesario.

Por ejemplo:

  * Para los resultados electorales de 2020 presidente y vicepresidente: Se quiere estudiar el comportamiento de votos Nulos y Blancos para el departamento de Tarija
  * Para la encuesta a hogares 2019, se quiere estudiar los años de educación, condición de pobreza moderada, edad e ingreso laboral de las jefas de hogar.

### Selección/filtrado de observaciones (filas)

El objetivo en este punto es trabajar sobre la unidad de análisis, que define a la población objetivo.

Ejercicio: obtener la base de datos filtrada de los ejemplos anteriores. 

```{r}
rm(list = ls())
library(dplyr)
#electoral
load("/cloud/project/DataMining/bd_elecciones20.RData")
unique(bdpv$Departamento)
bdtj<-bdpv %>% filter(Departamento=="Tarija")
#eh 2019
load(url("https://github.com/AlvaroLimber/EST-384/raw/master/data/eh19.RData"))

aux<-unique(eh19p$s02a_02)
aux[2]
relacion<-unique(eh19p$s02a_05)

ehjm<-eh19p %>% filter(s02a_02==aux[2] & s02a_05==relacion[1])
```

Ejercicio

Obtener una base de datos de la EH19 que incluya solamente a los suegros, padres y otros parientes.

```{r}
relacion[c(4,8,10)]
ehmis<-eh19p %>% filter(s02a_05 %in% relacion[c(4,8,10)])
```

Ejemplo, se quiere estudiar la bd electoral para presidente en todas las mesas, excepto las de Tarija.

```{r}
bdntj<-bdpv %>% filter(Departamento!="Tarija")
```

### Selección de variables (columnas)

El objetivo es trabajar únicamente con las variables necesarias para el estudio, es decir, las que se utilizaran en el modelado posterior.

Ejemplo, realizar la selección de variables para los ejemplos anteriores:

```{r}
# Para los resultados electorales de 2020 presidente y vicepresidente: Se quiere estudiar el comportamiento de votos Nulos y Blancos para el departamento de Tarija
names(bdpv)
bdtj<-bdpv %>% filter(Departamento=="Tarija") %>% select(Blancos,Nulos,`Votos Válidos`,Provincia,Municipio,Recinto)
object.size(bdpv)
object.size(bdtj)

#Para la encuesta a hogares 2019, se quiere estudiar los años de educación, condición de pobreza moderada, edad e ingreso laboral de las jefas de hogar.
ateh<-attributes(eh19p)
ehjm<-eh19p %>% filter(s02a_02==aux[2] & s02a_05==relacion[1]) %>% select(aestudio,p0,s02a_03,ylab,folio,nro,factor,estrato, upm)
#eh19p %>% select(-folio)
#eh19p %>% select(-c(folio,area))
#eh19p %>% select(1:5) # primeras 5 variables
#eh19p %>% select(z:pext2)  
```

### Pivot, Reshape
### Uniendo bases de datos
## Muestreo, estimación, error estándar y confiabilidad
### Diseño muestral
### Estimación
### Rendimiento
## Transformación
### Adecuación de formatos
### Limpieza de texto
### Creación de variables
### Valores atípicos
### Valores perdidos